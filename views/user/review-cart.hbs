<section
  class="cart py-4"
  style="background-color: rgb(228, 228, 228);min-height:30rem"
>
  <div class="container">
    {{#if (not total)}}
      <div class="cart-empty d-flex flex-column">
        <h4 class="text-center text-secondary my-auto">Cart is empty</h4>
        <i
          class="fa fa-2xl text-center text-secondary mt-4 mb-3 fa-cart-shopping"
        ></i>
        <hr />
      </div>
    {{/if}}
    <div class="row">
      {{#if total}}
      <div class="col-lg-8">
        <div class="card mt-3 p-3">
          <div class="accordion" id="accordionExample">
                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingOne">
                        <button class="accordion-button text-secondary" type="button" data-bs-toggle="collapse"
                            data-bs-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
                            <i class="fa fa-lg me-3 fa-plus"></i>
                            Add new address
                        </button>
                    </h2>
                    <div id="collapseOne" class="accordion-collapse collapse" aria-labelledby="headingOne"
                        data-bs-parent="#accordionExample">
                        <div class="accordion-body">
                            <form action="" id="addressForm">
                                <div class="row">
                                    <div class="mb-4">

                                        <div class="form-outline">
                                            <label for="exampleInputEmail1" class="form-label font-color">Full
                                                Name</label>
                                            <input type="text" class="form-control" name="name" id="name"
                                                aria-describedby="emailHelp" placeholder="Type here" />
                                        </div>

                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-4">
                                        <div class="form-outline">
                                            <label for="exampleInputEmail1"
                                                class="form-label font-color">Address</label>
                                            <input type="text" class="form-control" name="address" id="address"
                                                aria-describedby="emailHelp" placeholder="Type here" />
                                        </div>
                                    </div>
                                    <div class="col-md-6 mb-4">

                                        <label for="exampleInputEmail1" class="form-label font-color">City</label>
                                        <input type="text" class="form-control" name="city" id="city"
                                            aria-describedby="emailHelp" placeholder="Type here" />
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-4">
                                        <div class="form-outline">
                                            <label for="exampleInputEmail1" class="form-label font-color">State</label>
                                            <input type="text" class="form-control" name="state" id="state"
                                                aria-describedby="emailHelp" placeholder="Type here" />
                                        </div>
                                    </div>
                                    <div class="col-md-6 mb-4">

                                        <label for="exampleInputEmail1" class="form-label font-color">Country</label>
                                        <input type="text" class="form-control" name="country" id="country"
                                            aria-describedby="emailHelp" placeholder="Type here" />
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-4">
                                        <div class="form-outline">
                                            <label for="exampleInputEmail1" class="form-label font-color">Postal
                                                Code</label>
                                            <input type="text" class="form-control" name="pincode" id="pincode"
                                                aria-describedby="emailHelp" placeholder="Type here" />
                                        </div>
                                    </div>
                                    <div class="col-md-6 mb-4">

                                        <label for="exampleInputEmail1" class="form-label font-color">Contact
                                            No.</label>
                                        <input type="tel" class="form-control" name="contact" id="contact"
                                            aria-describedby="emailHelp" placeholder="Type here" />
                                    </div>
                                </div>
                                <div class="text-center">
                                    <button class="btn btn-primary" type="submit">Add address</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {{#each addresses}}
          <div class="card mt-3 p-3">
            <div class="accordion" id="accordionExample">
              <div class="accordion-item">
                <div class="d-flex justify-content-between p-3">
                  <div class="d-flex flex-column text-secondary">
                    <h6 class="mt-3">
                      {{this.address}},{{this.city}},{{this.state}},{{this.country}},{{this.pincode}}</h6>
                    <h6>{{this.contact}}</h6>
                  </div>
                  <div class="ms-auto d-flex">
                    <a
                      class="accordion-button text-secondary"
                      type="button"
                      data-bs-toggle="collapse"
                      data-bs-target="#collapseOne{{this._addId}}"
                      aria-expanded="true"
                      aria-controls="collapseOne"
                    >
                      <i class="fa fa-pen-to-square"></i>
                    </a>
                    
                    <input
                    class="my-auto d-flex float-right"
                      type="radio"
                      id="f-option6"
                      name="payement-method"
                      value="ONLINE"
                      onclick="changeAddressStatus('{{this._addId}}')">
                  </div>
                </div>
                <div
                  id="collapseOne{{this._addId}}"
                  class="accordion-collapse collapse"
                  aria-labelledby="headingOne"
                  data-bs-parent="#accordionExample"
                >
                  <div class="accordion-body">
                    <form action="" id="editAddressForm{{this._addId}}">
                      <div class="row">
                        <div class="mb-4">

                          <div class="form-outline">
                            <label
                              for="exampleInputEmail1"
                              class="form-label font-color"
                            >Full Name</label>
                            <input
                              type="text"
                              class="form-control"
                              name="name"
                              id="name"
                              aria-describedby="emailHelp"
                              placeholder="Type here"
                              value="{{this.name}}"
                            />
                          </div>

                        </div>
                      </div>
                      <div class="row">
                        <div class="col-md-6 mb-4">
                          <div class="form-outline">
                            <label
                              for="exampleInputEmail1"
                              class="form-label font-color"
                            >Address</label>
                            <input
                              type="text"
                              class="form-control"
                              name="address"
                              id="address"
                              aria-describedby="emailHelp"
                              placeholder="Type here"
                              value="{{this.address}}"
                            />
                          </div>
                        </div>
                        <div class="col-md-6 mb-4">

                          <label
                            for="exampleInputEmail1"
                            class="form-label font-color"
                          >City</label>
                          <input
                            type="text"
                            class="form-control"
                            name="city"
                            id="city"
                            aria-describedby="emailHelp"
                            placeholder="Type here"
                            value="{{this.city}}"
                          />
                        </div>
                      </div>
                      <div class="row">
                        <div class="col-md-6 mb-4">
                          <div class="form-outline">
                            <label
                              for="exampleInputEmail1"
                              class="form-label font-color"
                            >State</label>
                            <input
                              type="text"
                              class="form-control"
                              name="state"
                              id="state"
                              aria-describedby="emailHelp"
                              placeholder="Type here"
                              value="{{this.state}}"
                            />
                          </div>
                        </div>
                        <div class="col-md-6 mb-4">

                          <label
                            for="exampleInputEmail1"
                            class="form-label font-color"
                          >Country</label>
                          <input
                            type="text"
                            class="form-control"
                            name="country"
                            id="country"
                            aria-describedby="emailHelp"
                            placeholder="Type here"
                            value="{{this.country}}"
                          />
                        </div>
                      </div>
                      <div class="row">
                        <div class="col-md-6 mb-4">
                          <div class="form-outline">
                            <label
                              for="exampleInputEmail1"
                              class="form-label font-color"
                            >Postal Code</label>
                            <input
                              type="text"
                              class="form-control"
                              name="pincode"
                              id="pincode"
                              aria-describedby="emailHelp"
                              placeholder="Type here"
                              value="{{this.pincode}}"
                            />
                          </div>
                        </div>
                        <div class="col-md-6 mb-4">

                          <label
                            for="exampleInputEmail1"
                            class="form-label font-color"
                          >Contact No.</label>
                          <input
                            type="tel"
                            class="form-control"
                            name="contact"
                            id="contact"
                            aria-describedby="emailHelp"
                            placeholder="Type here"
                            value="{{this.contact}}"
                          />
                        </div>
                        <input
                          type="text"
                          name="_addId"
                          value="{{this._addId}}"
                          hidden
                        />
                      </div>
                      <div class="text-center">
                        <button
                          class="btn btn-primary"
                          onclick="editAddress('{{this._addId}}')"
                          type="submit"
                        >Edit address</button>
                      </div>
                    </form>
                  </div>
                </div>
              </div>
            </div>
          </div>
        {{/each}}
      </div>
        <div class="col-lg-4 p-3">
          <form action="" id="couponForm">
            <div class="card p-4 mb-4">
              <div class="row">
                <div class="col-9">
                  <input type="text" name="couponCode" class="form-control">
                </div>
                <div class="col-3">
                  <button class="button" type="submit">Apply</button>
                </div>
              </div>
            </div>
          </form>
          <div class="card text-secondary justify-content-center">
            <div class="pricebox-review">
              <div class="d-flex justify-content-between mt-3">
                <div class="keys ms-4">
                  <h6>Model</h6>
                </div>
                <div class="values me-4">
                  <h6>Total</h6>
                </div>
              </div>
              {{#each products}}
                <div class="d-flex justify-content-between mt-3">
                  <div class="keys ms-4">
                    <p class="font-color">{{this.product.model}}</p>
                  </div>
                  <div class="values me-4">
                    <p>{{this.quantity}}X<span
                        class="h6"
                      >₹{{this.product.bookprice}}</span></p>
                  </div>
                </div>
              {{/each}}
              <hr class="mx-4" />
              <div class="d-flex justify-content-between mt-3 my-3">
                <div class="keys ms-4">
                  <h6>Total booking price :</h6>
                  <h6>Tax(5%) :</h6>
                  <h6>Discount :</h6>
                  <h6>Total :</h6>
                </div>
                <div class="values me-4 text-end">
                  <h6>₹<span
                      id="totalBookPrice"
                    >{{totalBookingPrice.total}}</span></h6>
                  <h6>₹<span id="taxPrice">{{tax
                        totalBookingPrice.total
                      }}</span></h6>
                  <h6 class="text-success">₹<span id="discountPrice">0</span></h6>
                  <h6>₹<span id="grandTotal">{{sum
                        totalBookingPrice.total
                        (tax totalBookingPrice.total)
                      }}</span></h6>
                </div>
              </div>
            </div>
            <hr class="mx-4" />
            <form action="" id="checkoutForm">
              <div class="d-flex justify-content-between mt-3 my-3">
                <div class="keys ms-4">
                  <h6>Payment method:</h6>
                </div>
                <select
                  class="form-select me-3"
                  aria-label="Default select example"
                  name="payment-method"
                  aria-placeholder="Choose option"
                  required
                >
                  <option value="" disabled selected>Choose option</option>
                  <option value="Online">Online Payment</option>
                  <option value="COD">COD</option>

                </select>
                {{!-- Extra --}}
                <input type="text" id="orderGrandTotal" name="orderGrandTotal" value="{{sum
                        totalBookingPrice.total
                        (tax totalBookingPrice.total)
                      }}" hidden>

                <input type="text" id="couponId" name="couponId"  hidden>
                <input type="text" id="discount" name="discount" hidden>
              </div>
              <div
                class="col-12 d-flex flex-column justify-content-center align-items-center mb-4"
              >

                <button class="button" type="submit">Checkout</button>
              </div>
            </form>
          </div>
        </div>
      {{/if}}
    </div>
  </div>
</section>

<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
  document.getElementById('couponId').value = null
  document.getElementById('discount').value = null
  jQuery.validator.addMethod("lettersonly", function (value) {
        return /^[a-z\s]+$/i.test(value);
    });
    $('#addressForm').validate({
        rules: {
            name: {
                required: true,
                lettersonly: true,
                minlength: 3
            },
            address: {
                required: true,
                lettersonly: true,
            },
            city: {
                required: true,
                lettersonly: true,
            },
            state: {
                required: true,
                lettersonly: true,
            },
            country: {
                required: true,
                lettersonly: true,
            },
            pincode: {
                required: true,
                number: true,
            },
            contact: {
                required: true,
                number: true,
                minlength: 10,
                maxlength: 10
            },
        },
        messages: {
            name: {
                lettersonly: "Enter only characters."
            },
            address: {
                lettersonly: "Enter only characters."
            },
            city: {
                lettersonly: "Enter only characters."
            },
            
            country: {
                lettersonly: "Enter only characters."
            },
            pincode: {
                number: "Enter a valid pincode",
            },
            contact: {
                minlength: "Please enter 10 digits.",
                maxLength: "Please enter 10 digits.",
            }
        },
        submitHandler : (form)=>{
            $.ajax({
                url:
                    '/add-address', type: 'POST', data: $('#addressForm').serialize(), 
                    success:
                    (response) => {
                        if (response.status) {
                            Swal.fire('Hooray!', 'Address added successfully', 'success')
                            setTimeout(() => { location.reload() }, 2000)
                        }
                    }
            })
        }
    })

  $("#checkoutForm").submit((e)=>{ 
    e.preventDefault();
    $.ajax({
      url:'/place-order', 
      method:'post', 
      data:$('#checkoutForm').serialize(),
      success:(response)=>{
        if(response.codSuccess){ 
          Swal.fire('Hooray!', 'Order placed successfully', 'success') 
          setTimeout(()=>{ 
            location.replace('/order-success/'+response.insertedId)
          },2000)
        }else{
          console.log(response)
          console.log("hello")
          razorpayPayment(response)
        }
      } 
    }) 
  })

  function razorpayPayment(order){
    var options = {
      "key": "rzp_test_ZXDZgB7Prl01fX", // Enter the Key ID generated from the Dashboard
      "amount": order.totalAmount, // Amount is in currency subunits. Default currency is INR. Hence, 50000 refers to 50000 paise
      "currency": "INR",
      "name": "Sayyarah",
      "description": "Online Payment",
      "image": "/public/images/logo.png",
      "order_id": order.id, //This is a sample Order ID. Pass the `id` obtained in the response of Step 1
      "handler": function (response){
          verifyPayment(response,order)
      },
      "prefill": {
          "name": order.user.fname,
          "email": order.user.email,
          "contact": order.orderDetails.deliveryDetails.contact
      },
      "notes": {
          "address": "Razorpay Corporate Office"
      },
      "theme": {
          "color": "#3399cc"
      }
    };
    var rzp1 = new Razorpay(options);
    rzp1.open();
  }
  function verifyPayment(payment,order){
    $.ajax({
      url:'/verify-payment',
      method:'post',
      data:{
        payment,
        order
      },
      success:(response)=>{
        console.log(response)
        if(response.status){
          location.replace('/order-success/'+ response.ordId)
        }else{
          alert("Payment failed",response.errMsg)
        }
      }
    })
  }


  function editAddress(addId){
    $("#editAddressForm"+addId).submit((e) => {
      e.preventDefault();
      $.ajax({
          url: '/edit-address', 
          method: 'post', 
          data: $('#editAddressForm'+addId).serialize(),
          success: (response) => {
              if (response.status) {
                  Swal.fire('Hooray!', 'Address updated successfully', 'success') 
                  setTimeout(()=>{ location.reload() },2000) 
              } 
          } 
      }) 
    })
  }

  function changeAddressStatus(addId){
    $.ajax({
      url: '/change-order-address/'+addId,
      method:'post',
      success:(response)=>{
        Swal.fire('Hooray!', 'Address changed successfully. Proceed to Checkout', 'success') 
        setTimeout(()=>{
          location.reload()
        },1000)
      }
    })
  }

  $('#couponForm').submit((e)=>{
    e.preventDefault()
    let totalBookingPrice = document.getElementById('grandTotal').innerHTML
    $.ajax({
      url:'/verify-coupon',
      data:$('#couponForm').serialize(),
      method:'post',
      success:(response)=>{
        console.log(response,'ninteee thantha')
        if(response.expired){
          Swal.fire('Coupon expired','Try different coupon', 'error') 
        }else if(response.used){
          Swal.fire( 'Coupon already used','Try different coupon', 'info') 
        }else if(response.orderLimit){
          Swal.fire( 'Order limit not reached','Purchase more', 'info') 
        }else if(response.valid){
          let discount = response.discountPrice
          document.getElementById('discountPrice').innerHTML = discount
          totalBookingPrice = totalBookingPrice - discount
          document.getElementById('grandTotal').innerHTML = totalBookingPrice
          document.getElementById('orderGrandTotal').value = totalBookingPrice
          document.getElementById('couponId').value = response._id
          document.getElementById('discount').value = discount
          Swal.fire( 'Congragulations','Coupon code applied', 'success')
        }else if(response.invalid){
          Swal.fire('Coupon not valid','Enter a valid coupon', 'error') 
        }
      }
    })
  })
</script>